\chapter{Inter-Vehicles}

\section{Global Positioning System}
The \textbf{\textit{GPS}} in origin named \textbf{NAVigation Satellite Timing and Ranging Global Positioning System} (\textbf{NAVSTAR GPS}) is one of the space-based \textit{global navigation satellite system} (\textbf{GNSS}) that provides \textbf{geolocation} and \textbf{time information} anywhere on the Earth, using the signal of at least four satellite. The geolocation information gives an \textbf{XYZ} coordinates.

\subsection{Actors}
\textbf{GPS} is based on three elements: \textbf{space segment} (the satellite), \textbf{control segment} (ground station) and \textbf{user segment} (end-user equipments):
\begin{enumerate}[nosep]
    \item \textbf{space segment}: have the main goal to broadcast navigation message constantly.
    \item \textbf{control segment}: ground antennas that \textit{track}, \textit{collect} and \textit{correct} all the \textbf{sat orbits} (normally they are very precise and known a priory). They both recive/transmit data from/to satellites.
    \item \textbf{user segment}: cheap devices used to collect GPS signal and know the position (it has the maximum error approximately of 1 meter).
\end{enumerate}

\subsection{NAV Msg}
The information \textbf{broadcasted} by the satellite is called \textbf{\textit{Navigation Message}} (\textbf{NAV}). The nav msg is composed by:
\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{img/gps_frame}
\end{figure}
\begin{itemize}[nosep]
    \item \textbf{25 frames} (or \textbf{pages}) that takes 12.5 minutes to be transmitted.
    \item each frame takes 30 seconds to be transmitted and it is formed by \textbf{6 sub-frame}.
    \begin{enumerate}[nosep]
        \item the first sub-frame contains the \textbf{satellite clock information}.
        \item the second and the third give the information about the \textbf{satellite ephemeris} (\textbf{orbit}).
        \item the forth and thr fifth are different and are complete only receiving all the 25 frames of the NAV msg, they have the \textbf{Almanac \& constellation status}.
    \end{enumerate}
    \item each sub-frame needs 6 seconds to be transmitted, and it is composed by \textbf{10 words}.
    \item each word consist of \textbf{30 bits} and it takes 0.6 second to be transmitted.
\end{itemize}

\newpage
\subsection{Bit Coding}
GPS use the \textbf{Bi-Phase Shift Key} (\textbf{BPSK}) modulation technique. In BPSK the carrier signal is modified by altering its phase by 180 degree, for each symbol. A phase shift of 180 degrees denotes a binary 0 while no phase shift represents a binary 1. The advantages to use this type of mudaltion technique is:
\begin{enumerate}[nosep]
    \item rendundancy
    \item jamming resistance
    \item measure \& remove the ionospheric delay
    \item requires a dual frequency receiver (with a single one it is possible to survive but less accuracy) one at $1575.42MHz$ and the other one at $1227.60MHz$.
\end{enumerate}
\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/bspk_wave}
\end{figure}
\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/bspk_signal}
\end{figure}

\newpage
\subsection{Working Principle}
Let's distinguish the study of the working principle in two hypotheses: \textbf{theoretical}: receiver clock is perfectly synchronize with the satellite clock (\textit{absolute clock}); and \textbf{reality}: receiver clock is cheap, non-atomic and not perfectly synchronize with the satellite clock.

\begin{figure}[h]
    \centering 
    \includegraphics[width=0.45\textwidth]{img/hp_theory}
    \caption{Satellite-Receiver clock synch}
\end{figure}
In the first hypothesis, we know: \textbf{satellite position} (written in the NAV), \textbf{satellite clock} (written in the NAV) and the \textbf{speed of light} $c$. So it is possible to obtain:
\begin{enumerate}[nosep]
    \item \textbf{signal travel time}: $\Delta t = clock_{recv} - clock_{NAV}$
    \item \textbf{distance satellite-receiver}: $d = c \cdot \Delta t$
\end{enumerate}
The problem is, if there is at least $1ms$ of de-sync between the satellite and the receiver, then will have at least an error of 200 miles.
Solution: \textbf{\textit{Trilateration}}.

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.3\textwidth}
        \centering
        \includegraphics[width=0.7\textwidth]{img/gps_one}

        \begin{flushleft}
            if it is knows \textbf{one} $sat_i$ and the distance $d_i$ we can be in any point of the spherical surface of radius $d_i$ centered in $sat_i$.
        \end{flushleft}
    \end{minipage}
    \begin{minipage}[t]{0.3\textwidth}
        \centering
        \includegraphics[width=0.7\textwidth]{img/gps_two}

        \begin{flushleft}
            if the sat known are \textbf{two} $sat_i$ and $sat_j$ both the position and the distance $d_i$, $d_j$ we can be in any point of the border given by the intersection of the two sphere's surface.
        \end{flushleft}
    \end{minipage}
    \begin{minipage}[t]{0.3\textwidth}
        \centering
        \includegraphics[width=0.7\textwidth]{img/gps_three}

        \begin{flushleft}
            adding the \textbf{third} sat, we have \textbf{three} sphere, that ends the intersection with two available points. One is on the Earth surface (us) the other is in the open space (discard).
        \end{flushleft}
    \end{minipage}
\end{figure}
In the \textbf{reality} the satellite and the receiver do not have the clock synchronize, so it is important to introduce a factor named \textit{clock error} $\Delta e$:
\begin{center}
    $d_i = \sqrt{(x_i - x_u)^2 + (y_i - y_u)^2 + (z_i - z_u)^2} + c \cdot \Delta e$
\end{center}
where:
\begin{itemize}[nosep]
    \item $x_i$, $y_i$ and $z_i$ are the sat position, \textbf{know} (NAV).
    \item $c$ is the speed of light, \textbf{know}.
    \item $x_u$, $y_u$ and $z_u$ are the position of the receiver, \textbf{unknown}.
    \item $\Delta e$ is the clock error, \textbf{unknown}.
\end{itemize}
If we consider four satellites $sat_i$, $sat_j$, $sat_k$ and $sat_p$ we end with four equations and four unknown items: $x_u$, $y_u$, $z_u$ and $\Delta e$.
\begin{center}
    \begin{math}
        \begin{cases}
            d_i = \sqrt{(x_i - x_u)^2 + (y_i - y_u)^2 + (z_i - z_u)^2} + c \cdot \Delta e \\
            d_j = \sqrt{(x_j - x_u)^2 + (y_j - y_u)^2 + (z_j - z_u)^2} + c \cdot \Delta e \\
            d_k = \sqrt{(x_k - x_u)^2 + (y_k - y_u)^2 + (z_k - z_u)^2} + c \cdot \Delta e \\
            d_p = \sqrt{(x_p - x_u)^2 + (y_p - y_u)^2 + (z_p - z_u)^2} + c \cdot \Delta e
        \end{cases}
    \end{math}
\end{center}
$\Delta e$ is equal for all satellite, because all of them are perfectly synchronize, so the \textit{clock error} is the same for each tuples (sat, recv). If recv and sat are perfectly synchronize (\textbf{time} given), with just 3 sat is possible to calculate your position. If you know where you are (\textbf{space} given), with just one sat is possible to have the clock sync, but if you do \textbf{not know} both \textbf{space} and \textbf{time} you need at least four sat to solve the equation.

\subsection{GPS limitation}
\begin{itemize}[nosep]
    \item it require a lot of power to work properly.
    \item GPS signal do not pass solid structure.
    \item affected by large buildings, unreliable in dense urban area.
    \item GPS accuracy is function of the signal reception, larger the antenna, better the signal. $miniaturization \quad \frac{1}{\alpha} \quad accuracy$
\end{itemize}

\newpage
\section{Bluetooth}
\textbf{\textit{Bluetooth}} is short-range wireless technology and it was introduce for the first time in 1994 to replace serial \textit{RS-232} wired cables. Typically used for \textbf{point-to-point} technologies. It has a coverage of 10m and creates a network named \textbf{Personal Area Network} (\textbf{PAN}), the frequency range is between $2.4GHz$ and $2.485GHz$ with few $Mbps$ of bandwidth. It is standardize in the \textit{IEEE 802.15.1} like packet-base protocol.

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{img/bluetooth_timeline}
    \caption{Bluetooth different version in the time}
\end{figure}

The bluetooth works at $2.4GHz$, like WiFi and ZigBee. A bluetooth network is named \textbf{piconet} and use a \textit{master}/\textit{slave} communication type. \\
In a bluetooth network there is always a \textbf{master} and up to seven \textbf{slave}, each slave can be only connected to one master. The master coordinates communication throughput the \textit{piconet} it can send data to every one slave connect and can request data to each slave. The slaves can only talk with the master not between them. 

\subsection{Address \& Names}
The identifier for each node into a piconet (both for slave and master) its a \textbf{unique 48 bits address}, commonly abbreviated \textbf{\textit{BD\_ADDR}}, usually is show as 12digit hexadecimal value, similar to the MAC address.
\begin{boxA}
    \textbf{Name} is pretty different, it is also possible to give to each slave an user-frendly name. It can be up to 248 bytes long and two device can share the same name.
\end{boxA}

\subsection{Connection Process}

\begin{figure}[h]
    \centering 
    \includegraphics[width=0.75\textwidth]{img/ble_con}
    \caption{Connection Procedure in Bluetooth}
    \label{fig:ble_con}
\end{figure}

Like show in Fig.~\ref{fig:ble_con}:
\begin{itemize}[nosep]
    \item \textbf{\textit{Inquiry Procedure}}: the goal of this part is to retrive the information of each nearby nodes. A node run an inquriy scan and any listening device for this type of request, replies with its address, name and other info.
    \item \textbf{\textit{Paging Procedure}}: the purpose of this process is to create a connection between two bluetooth device. Each device \textbf{must knows} the address of the other. \textbf{\textit{FHS}}: \textbf{Frequency Hopping Sequence}.
    \item \textbf{\textit{Connection Procedure}}: after the \textit{paging} process it is necessary to define the \textbf{connection state}.
\end{itemize}

\subsection{Connection}
A bluetooth connection can have four kinds of mode:
\begin{enumerate}[nosep]
    \item \textbf{\textit{active mode}}: this is regular connected mode, where the device is actively transmitting or receiving data.
    \item \textbf{\textit{sniff mode}}: the device is active periodically for a certain amount of time (\textit{power-saving mode}).
    \item \textbf{\textit{hold mode}}: is a temporary, power-saving mode where a device sleeps for a defined period (not necessarily periodic) and then returns back to active mode when the interval passed. The master can command a slave device to hold.
    \item \textbf{\textit{park mode}}: when the master command a slave to ``park'', that slave become inactive until the master tells it to wake up.
\end{enumerate}

\subsection{Pairing}
\begin{boxA}
    Paired devices automatically establish a connection whenever thery are close enough. No UI interaction are required.
\end{boxA}
When device pair up, they share their address, name and profiles. Usually all this information are stored in memory. They also share common \textbf{secret key}, which allow them to bond whenever they want. \\
Pairing usually requires an \textbf{authentication process} where a user must validate the connection between devices, it could be different depending on the domain, some device ask to \textbf{press a button} (headset) or other can ask to \textbf{insert a code} (PC or smartphone).

\newpage
\subsection{Power Class}
The transmit power and therefore range, of a bluetooth module is defined by its \textbf{power class}. There are three defined class power:
\begin{center}
    \begin{tabular}{ | c | c | c | c | } \hline
        \textbf{Class number} & \textbf{Max Output Power}$_{dBm}$ & \textbf{Max Output Power}$_{mW}$ & \textbf{Max Range} \\ \hline
        \textbf{class 1} & 20 & 100 & 100m \\ \hline
        \textbf{class 2} & 4 & 2.5 & 10m \\ \hline
        \textbf{class 3} & 0 & 1 & 10cm \\ \hline
    \end{tabular}
\end{center}

\subsection{Profiles}
While bluetooth \textbf{specification} define how the technology \textit{works}, \textbf{profiles} define how it is \textit{used}. Two bluetooth device are \textbf{compatible} if they \textbf{support the same profiles}. Some explanation of the most common bluetooth profiles:
\begin{itemize}[nosep]
    
    \item \textbf{\textit{Serial Port Profile}} (\textbf{\textit{SPP}}): permit to substitute a serial communication protocol (like RS-232 or UART). \textit{SPP} is great for sending data between two device

    \item \textbf{\textit{Human Interface Device}} (\textbf{\textit{HID}}): is the profile to enable the receiving data from the user-input device (like mice, keyboard or joystick). \textbf{Bluetooth HID} substitute \textbf{HID} alredy defined for human input USB device, the innovation is the substitution of the USB cable for the communication.

    \item \textbf{\textit{Hands-Free Profile}} (\textbf{\textit{HFP}}) and \textbf{\textit{Headset Profile}} (\textbf{\textit{HSP}}): \textit{HFP} implements a few features on top of \textit{HSP} to allow common phone interaction (accepting/rejecting calls, etc.) that occur while the phone remains in your pocket.

    \item \textbf{\textit{Advanced Audio Distribution Profile}} (\textbf{\textit{A2DP}}): \textit{A2DP} define how audio can be transmitted from one bluetooth device to another. \textit{HFP} and \textit{HSP} have a bidiretion communication, instead \textit{A2DP} is one-way street, that permit higher quality potential.

    \item \textbf{\textit{A/V Remote Control Profile}} (\textbf{\textit{AVRCP}}): the audio/video remote control profile allows for remote controlling of a bluetooth device. It is usually implemented alongside \textit{A2DP} to allow the remote speaker to tell the audio-sending device fast-forward, rewind, etc.

\end{itemize}

\subsection{Bluetooth Stack}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.85\textwidth]{img/ble_stack}
    \caption{Bluetooth Stack}
    \label{fig:ble_stack}
\end{figure}

The bluetooth protocol stack is split in two parts: a \textbf{controller stack} (in Fig.~\ref{fig:ble_stack} the blu/gray section) containing the timinig critical radio interface and \textbf{host stack} (in Fig.~\ref{fig:ble_stack} the biggest container) dealing with high level data. \\ \newline
\textbf{\textit{Radio Layer}} \\
The bluetooth radio layer is used for transmit bit from master to slave (or vice-versa) and it is similar to \textit{physical layer} in ISO/OSI model. It is a \textbf{low-power system} with 10 meters range operating in the same frequency of WiFi and ZigBee: $2.4GHz$. It defines the specification for the transceiver device:
\begin{enumerate}[nosep]
    \item \textbf{\textit{Frequency Bands and Channel Arrangement}} (\textbf{\textit{FHSS}})
    \item \textbf{Transmitter Characteristics}
    \item \textbf{Receiver Characteristics}
\end{enumerate}
The \textbf{\textit{Frequency Hopping Spread Spectrum}} is used for the transmission. The \textbf{Spectrum Spreading} is obtain by hopping between 79 frequency segments distributed between $2.402GHz$ and $2.480GHz$ ($1MHz$). The transmitter and receiver stay on one of this channels for a certain time and then hop to another channel. This system implement \textbf{Frequency Division Multiplexing} (\textbf{FDM}) and \textbf{Time Division Multiplexing}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{img/ble_fhss}
    \caption{Frequency Hopping Spread Spectrum}
\end{figure}
The changes of frequency it could be performed in two different way:

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{img/ble_hop}
\end{figure}
\begin{itemize}[nosep]
    
    \item \textbf{\textit{slow hopping}}: the transmitter uses one frequency for several bit period:
    \begin{itemize}[nosep]
        \item typically cheaper (relaxed sync constraints, more time per slot)
        \item not immune to narrowband Interference
    \end{itemize}
    
    \item \textbf{\textit{fast hopping}}: the transmitter uses several frequencies for one period:
    \begin{itemize}[nosep]
        \item typically expensive (hard sync constraints, more slot jumps and high resync frequency)
        \item almost immune to narrowband
        \item rate 1600 hops/sec: $625 \mu s$ of slot time
    \end{itemize}

\end{itemize}
\textbf{\textit{Baseband Layer}} \\
While the \textbf{radio layer} is controlled by the transceiver, the \textbf{baseband layer} is implemented by the controller of a device how want to transmit in bluetooth. The \textit{baseband} is the \textbf{physical layer} of the bluetooth and is used to manages physical channel and links, but also \textit{error connection}, \textit{data whitening}, \textit{hop selection} and \textit{bluetooth security}. \\
Is is used to managed \textbf{synchronous} and \textbf{asynchronous} links. It handles packet and perform the \textit{inquiry} and the \textit{paging} for create connection with nearby device. The baseband layer applies a \textbf{time division duplex} (\textbf{TDD}) scheme to alternating transmitter and receiver. Baseband handles two types of links:
\begin{enumerate}[nosep]
    \item \textbf{\textit{Synchronous Connection Oriented}} link (\textbf{\textit{SCO}}): is a symmectric point-to-point link between a master and a single slave in the piconet. The master maintains the \textit{SCO} link by using reserved slot at regular intervals:
    \begin{itemize}[nosep]
        \item \textit{SCO} is commonly used for the transmission of voice information.
        \item master can support up to three simultaneously \textit{SCO} links, instead, slave only two (sometimes three).
        \item \textit{SCO} packets are never re-transmitted, normally used for $64kB/s$ speech transmission.
    \end{itemize}
    \item \textbf{\textit{Asynchronous Connection Less}} link (\textbf{\textit{ACL}}): is point-to-multipoint between the master and all the slave present in the piconet. In the slot not reserved for the \textit{SCO} links, the master can establish an \textit{ACL} link to any slave
    \begin{itemize}[nosep]
        \item slave alredy into a \textit{SCO} communication are included.
        \item only a single \textit{ACL} link can exist.
        \item for most of \textit{ACL} packets, re-transmission is applied.
    \end{itemize}
\end{enumerate}
These means that \textit{SCO} does not need a connection, there is not an acknoledgement (like \textbf{UDP}), instead the \textit{ACL} need the \textit{ACK} to check if the message needs to be re-transmitted (like \textbf{TCP}). \\
\textbf{\textit{Bluetooth Packet}}
\begin{center}
    \begin{tabular}{ | c | c | c | c | } \hline
        \textbf{bits} & 72 & 54 & 0 - 2745 \\ \hline
        \textbf{description} & \textbf{access code} & \textbf{header} & \textbf{payload} \\ \hline
    \end{tabular}
\end{center}
\begin{enumerate}[nosep]
    \item \textbf{\textit{access code}}: is used for \textit{time synchronization}, \textit{offset compensation}, \textit{paging} and \textit{inquiry}.
    \item \textbf{\textit{header}}: contains information for \textit{packet acknoledgement}, \textit{packet numbering} for out-of-order packet reordering, \textit{flow control}, \textit{slave address} and \textit{error check} for header.
    \item \textbf{\textit{payload}}: can contain either voice field, data field or both. The payload will also contain a \textbf{payload header}.
\end{enumerate}
\textbf{\textit{Other Baseband Function}} \\
The baseband makes other features available like:
\begin{enumerate}[nosep]
    \item \textbf{\textit{error correction}}:
    \begin{itemize}[nosep]
        \item $\frac{1}{3}$ \textbf{rate FEC} (\textbf{Forward Error Correction}): every bit is repeated three times (\textbf{rendundancy}), in this way the receiver can discard up to two bits and validate the transmission.
        \item $\frac{2}{3}$ \textbf{rate FEC}: it use a \textit{polynomial generator} to \textbf{encode} ten bits code into fiftheen bits code.
        \begin{boxA}
            If i want to send $1010001111$ that is ten bits long, i divide into two pieces: $10100$ and $01111$ and i will compute the XOR: $10100 \oplus 01111 = 11011$. I will send the three concatenated values: $m = [10100, 01111, 11011]$. The receiver it could receive wrong the second value, but it can rebuild it performing the XOR between the first and third value. It allow only one ``wrong'' value, if not it can not reconstruct the original message.
        \end{boxA}
        \item \textbf{ARQ scheme} (\textbf{Automatic Repeat Request}): uses \textit{ACK}, \textit{NACK}, \textit{RTO}, etc.
    \end{itemize}
    \item \textbf{\textit{flow control}}: use \textbf{FIFO} queues both in \textit{ACL} and \textit{SCO} links for transmission and receive. In the case that the \textbf{RX FIFO} queues are full, \textbf{flow control} is used to avoid \textbf{congestion} and \textbf{packet drop}. The receiver send a \textbf{stop} indication, the transmitter \textbf{blocks} its \textbf{TX FIFO} queues. When the queues of the receiver are ready it sends an \textbf{go} signal to resume the transmission.
    \item \textbf{\textit{synchronization}}: the piconet is sync using the master clock and it is needed for the transmission at least three information:
    \begin{itemize}[nosep]
        \item \textbf{channel hopping sequence}
        \item \textbf{phase of the sequence}
        \item \textbf{channel access code} to place on the packets (piconet code)
    \end{itemize}
    \item \textbf{\textit{security}}: at link layer, security is maintained by authentication of the peers and encryption of the information. For this basic security we need a public address which is unique for each device, two secret key (authentication keys and encryption keys) and a random number generator.
\end{enumerate}
\textbf{\textit{Link Manager Layer}} \\
On top that layer it is used the \textbf{\textit{Link Manager Protocol}} (\textbf{\textit{LMP}}) that carries out link setup, authentication, link configuration and other protocol. The Link-Controller/Baseband provides services to \textbf{LMP} likes: \textit{authentication}, \textit{pairing}, \textit{encryption}, \textit{change link key}, \textit{slot/clock offset request}, \textit{switch master/slave role}, \textit{hold/sniff/park role} and \textit{quality of service}. \\
\textbf{\textit{Automotive \& Bluetooth}}:
\begin{itemize}[nosep]
    \item \textbf{in-car infortainment system}: permit hands-free audio, calling and application control.
    \item \textbf{remote keyless system}: smart phone are the new key, that use \textit{proximity detection} for locking and unlocking car.
    \item \textbf{in-vehicle wearables}: permit to monitoring the driver health.
    \item \textbf{under-the-hood \& connected maintenance}: allow to transfer diagnostic information.
\end{itemize}
\begin{center}
    \begin{tabular}{ | c | c | c | } \hline
        & \textbf{bluetooth} & \textbf{bluetooth low energy} \\ \hline
        \textbf{freq. band} & $2.4GHz$ ISM Band & $2.4GHz$ ISM Band \\ \hline
        \textbf{no. of channel} & 79, one $1MHz$ & 40, one $2MHz$ \\ \hline
        \textbf{power consumption} & low & less \\ \hline
        \textbf{data rate} & between $1Mbps$ and $3Mbps$ & $1Mbps$ \\ \hline
        \textbf{latency} & $\approxeq$ 100ms & $\approxeq$ 6ms \\ \hline
        \textbf{range} & < 30m & 50m (in open area: 150m) \\ \hline
        \textbf{topology} & peer-to-peer (1:1) & \begin{tabular}{@{}c@{}}peer-to-peer (1:1) \\ star (many:1) \\ broadcast (1:many) \\ mesh (many:many) \end{tabular} \\ \hline
        \textbf{device pairing} & required & not required \\ \hline
        \textbf{voice capable} & yes & no \\ \hline
        \textbf{node/active slave} & 7 & unlimited \\ \hline
        \textbf{security} & 64bits or 128 bits & 128 bits AES \\ \hline
        \textbf{smartphone compatibility} & 100\% & 100\% \\ \hline
        \textbf{use cases} & 
        \begin{tabular}{@{}c@{}}
            streaming application \\ 
            like audio streaming, \\ 
            file transfer and
            \\ headset 
        \end{tabular} & 
        \begin{tabular}{@{}c@{}}
            location beacons, \\ 
            smart home application, \\ 
            medical deivces, \\ 
            industrial monitoring \\ 
            and fitness trackers 
        \end{tabular} \\ \hline
    \end{tabular}
\end{center}

\newpage
\section{LoRa: Long Range}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.5\textwidth]{img/lora}
\end{figure}
\textbf{LoRa} has an unlicenced frequency band equal to: $868MHz$ (in Europe) and very long range coverage: up to \textbf{10 km}. It is composed by two part:
\begin{enumerate}[nosep]
    \item \textbf{LoRa}: the \textit{physical layer} that is \textbf{proprietary}.
    \item \textbf{LoRaWAN}: \textbf{Long Range Wide Area Network} that defines the upper layers (in particular MAC layer).
\end{enumerate}

\newpage
\subsection{LoRa Stack}

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.3\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img/lora_stack}
        \caption{LoRa Stack}
    \end{minipage}
    \begin{minipage}[t]{0.65\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img/lora_network}
        \caption {LoRaWAN network architecture}
        \label{fig:lora_net}
    \end{minipage}
\end{figure}
\textbf{LoRaWan} defines the \textit{MAC Layer}, the point-to-point network, the communication protocol and the system architecture standard (Fig. \ref{fig:lora_net}). It, also, managed the \textit{frequency}, \textit{data rate} and \textit{power device}.
\begin{itemize}[nosep]
    \item \textbf{end device, node} an embedded object with low-power communication constraints.
    \item \textbf{gateway} receive broadcast data and send data from/to the \textit{end device}.
    \item \textbf{network server} route message from \textit{end device} to the right application, and back.
\end{itemize}
\textbf{\textit{Addressing}}: to each \textit{device} is assign an \textbf{unique identifier} (\textbf{DevEUI}) of 64 bits, instead to each \textit{application} is attribute \textbf{distinctive fingerprint} (\textbf{AppEUI}) of 64 bits, moreover after the access inside a network of a new device it receives a \textbf{dynamic} \textit{non-unique} address of 32 bits (\textbf{DevAddr}). \\ \newline
\textbf{\textit{Frame Counter}} prevent \textbf{replay attack}, to prevent this each nodes (both \textit{end device} and \textit{server}) reject message that contain frame counter that is lower than the expected ones.

\newpage
The \textit{end device} could be classified into \textbf{three different classes}:
\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img/lora_classA}
        \caption{\textbf{Class A}}

        \begin{flushleft}
            Support bidirectional communication (from/to gateway), transmission messages can be sent in any time (random), two possible receive windows at specific time (after 1s and after 2s) after a transmission message, the gateway can reply in one of this two windows.
        \end{flushleft}
    \end{minipage}
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img/lora_classB}
        \caption{\textbf{Class B}}

        \begin{flushleft}
            Extend \textit{class A} by adding scheduled receive windows for receiving message from the gateway/server. It use time-sync beacons transmitted by the gateway, the \textit{end device} periodically open receive window.
        \end{flushleft}
    \end{minipage}
\end{figure}

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=\textwidth]{img/lora_classC}
        \caption{\textbf{Class C}}

        \begin{flushleft}
            Extend \textit{class A} by keeping the receive window open unless they are transmitting. This allow \textbf{low latency} communication, but it consume more energy than \textit{class A} device.
        \end{flushleft}
    \end{minipage}
\end{figure}

\subsection{Secuirty}
LoRaWAN specifies three different class of \textbf{security keys}: \textbf{\textit{NwSKey}}, \textbf{\textit{AppSKey}} and \textbf{\textit{AppKey}}, all have the lenght of 128 bits. The algorithm use for the encryption is \textbf{\textit{AES-128}}. \\
When a device joins the network (called \textbf{activation} or \textbf{join}), an \textit{application session key} (\textbf{AppSKey}) and \textit{network session key} (\textbf{NwSKey}) are generated that will be used for the duration of the session. The \textbf{AppSKey} is the \textit{private key}, instead the \textbf{NwSKey} is the \textit{public key}. The \textbf{Network Session Key} is used for the interaction between the node and the server and it is used to validate the integrity of each message using the \textbf{Message Integrity Code} (\textbf{MIC}). The \textbf{MIC} is similar to checksum expect that it prevents intentional tampering with message (\textbf{AES-CMAC}), it is also used to map the \textbf{DevAddr} to both \textbf{AppEUI} and \textbf{DevEUI}. The \textbf{Application Session Key} is used for encryption and decryption of the payload. \\
The \textbf{Application Key} (\textbf{AppKey}) is only know by the device and the application. The \textbf{NwSKey} and \textbf{AppSKey} are derived from this key. If you dinamically activate the device (\textbf{Over the Air Activation - OTAA}) the two sessione key are regenerate.

\subsection{MAC Commands}
The \textit{end device} and the \textit{server} use \textbf{MAC Commands} for configure the transmission and for the communication.
\begin{itemize}[nosep]
    \item checking connectivity
    \item requesting the status of the device
    \item adapting the data rate of the device
    \item modify channel settings
\end{itemize}

\begin{center}
    \begin{tabular}{ | c | c | } \hline
        \textcolor{green}{\textbf{Pros}} & \textcolor{red}{\textbf{Cons}} \\ \hline
        long range & not realtime data (packet each minutes) \\ \hline
        low power & not use for domotic house (ZigBee or Bluetooth) \\ \hline
        \begin{tabular}{@{}c@{}}
            low cost \\ 
            $\approxeq$ 20\$ per node
        \end{tabular} & watch video (WiFi) \\ \hline
        \begin{tabular}{@{}c@{}}
            low bandwidth \\ 
            between $250bit/s$ and $11kbit/s$
        \end{tabular} & \\ \hline
        \begin{tabular}{@{}c@{}}
            secure: 128 bits \\ 
            end-to-end encryption
        \end{tabular} & \\ \hline
    \end{tabular}
\end{center}

\newpage
\section{V2X}
\textbf{\textit{Intelligent Transportation System}} (\textbf{\textit{ITS}}) add information and communications technology to transport infrastructures and vehicles in effort to improve their safety, relaibility, efficiency and quality $\rightarrow$ avoid congestion (easy work for the drivers). \\ 
\textbf{\textit{European Telecommunication Standard Institute}} (\textbf{\textit{ETSI}}) standardize some new messages that allows to be transmitted into the network: \textbf{\textit{CAM}} and \textbf{\textit{DENM}} to permit safety, a new way to send broadcast message into the network, efficiency and enabling the \textbf{QoS} in the frame. \\

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.3\textwidth}
        \centering
        \textbf{\textit{V2X}}
    \end{minipage}
    =
    \begin{minipage}[t]{0.3\textwidth}
        \centering
        \textbf{\textit{IVC}} \\ 
        (\textbf{\textit{Inter-Vehicles Communication}})
    \end{minipage}
    =
    \begin{minipage}[t]{0.3\textwidth}
        \centering
        \textbf{\textit{VANET}} \\ 
        (\textbf{\textit{Vehicle ad-Hoc Network}})
    \end{minipage}
\end{figure}
Different name, but same thing. Today the most used and the standardize one is the \textbf{V2X}, that indicates multiples thigs that can be connect with the vehicle:
\begin{itemize}[nosep]
    \item \textbf{V2V}: vehicular-to-vehicular
    \item \textbf{V2I}: vehicular-to-infrastructure network
    \item \textbf{other}: it depends on top of which domain are created
\end{itemize}
It is possible identify two different \textbf{application} for \textbf{V2X}:

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.35\textwidth}
        \centering
        \textbf{\textit{Non Safety Purpose}} \\ ($\cong$ Infotainment): many messages and high data-rate, low latency and low reliability demand.
    \end{minipage}
    \begin{minipage}[t]{0.55\textwidth}
        \centering
        \textbf{\textit{Safety Purpose}} ($\cong$ X-by-Wire): few message (sporadic) and small packet size, high latency and high reliability demand. It is not possible to tollerate false positive or true negative messages.
    \end{minipage}
\end{figure}
Based on the requirements of the domain where we want deploy \textbf{V2X} we can have different application with different characteristics (latency, reliability, area and persistence).

\newpage
\textbf{\textit{Timeline}}

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.2\textwidth}
        \centering
        \textbf{\textit{Traditional Network}}
        \begin{itemize}[nosep]
            \item wired
            \item non-moving nodes
            \item static configuration
        \end{itemize}
    \end{minipage}
    $\rightarrow$
    \begin{minipage}[t]{0.35\textwidth}
        \centering
        \textbf{\textit{Mobile ad-Hoc Network}} (\textbf{\textit{MANET}})
        \begin{itemize}[nosep]
            \item wireless
            \item mobile nodes
            \item dynamic configuration
            \item infrastructure (optinal): WiFi and Mobile cellular line.
        \end{itemize}
    \end{minipage}
    $\rightarrow$
    \begin{minipage}[t]{0.35\textwidth}
        \centering
        \textbf{\textit{Vehicular ad-Hoc Network} (\textbf{\textit{VANET}})}
        \begin{itemize}[nosep]
            \item dynamic topologies (could be bus or star)
            \item infrastructure(less)
            \item broadcast or unicast messages
        \end{itemize}
    \end{minipage}
\end{figure}
It is necessary to change the name from \textbf{MANET} to \textbf{VANET} because there is two main different purpose of the network utilization moreover \textbf{VANET} could change its own topologies dynamically.
It is possible to distinguish \textbf{VANET} in two different scenario:
\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=0.75\textwidth]{img/v2x_freeway}

        \begin{flushleft}
            With only ``one direction'' for the movement we can have a \textit{stable connection} (if the vehicles are going in same the way) or \textit{unstable connection}, if the vehicles are not going in the same way (few second of connections).
            \textbf{Autonomous Drive} is drammatic easy on freeway (no cross road or obstacles)
        \end{flushleft}
    \end{minipage}
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=0.75\textwidth]{img/v2x_urban}

        \begin{flushleft}
            There are ``two direction'' for movement. The circumstances can change based on the environment: if the vechicle is driving it can have few neighbor (multiple hops to reach someone faraway), instead in a parking area the number of neighbor it can be easily increase. In the urban scenario it can be possible to have \textit{obstacles}: \textbf{GPS} not always work.
        \end{flushleft}
    \end{minipage}
\end{figure}
\begin{boxA}
    \textbf{\textit{Firmware Over The Air}} (\textbf{\textit{FOTA}}) \\
    \textbf{\textit{Stationary Support Units}} (\textbf{\textit{SSU}}): it is the name give to a nodes that is more important than the other and can have multiple scope:
    \begin{itemize}[nosep]
        \item provide connectivity to other nodes.
        \item manage the radio use for connectivity purpose.
        \item unlimited power supply.
        \item is not connected to internet: is part of the jungle, but more important.
    \end{itemize}
    \textbf{\textit{RoadSide Unit}} (\textbf{\textit{RSU}}): it is an \textbf{SSU} with the internet connection, you can act as a piece of the infrastructure and can enable the traffic to the \textbf{\textit{Traffic Information Center}} (\textbf{\textit{TIC}}).
\end{boxA}
It is possible identify two different \textbf{infrastructure} for \textbf{V2X}:

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{\textit{infrastructure}} \\ (problem alredy solve):
        \begin{itemize}[nosep]
            \item resource management.
            \item add latency (multiple hops).
            \item high load on the \textit{core network}.
            \item high throughput.
        \end{itemize}
    \end{minipage}
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{\textit{infrastructureless}}:
        \begin{itemize}[nosep]
            \item self organized: channel access and authentication are the biggest problem.
            \item low latency (no multiple hops).
            \item low datarate: wireless environment in which multiple nodes can communicate simultaneously.
        \end{itemize}
    \end{minipage}
\end{figure}
In the \textbf{infrastructureless} scenario it is necessary to define by your own the rules that the nodes must be compliant to, to allow communication. Moreover there are an heterogeneous scenario to support where the communication can be \textit{point-to-point} or \textit{broadcast}.

\newpage
\begin{figure}[h]
    \noindent
    \begin{minipage}[t]{0.05\textwidth}
        \vfill
        \begin{center} \rotatebox{90}{\textbf{CHALLENGES}} \end{center}
        \vfill
    \end{minipage}
    \begin{minipage}[t]{0.9\textwidth}
        \centering
        \begin{tabular}{
            |p{\dimexpr.35\linewidth-2\tabcolsep-1.3333\arrayrulewidth}
            |p{\dimexpr.55\linewidth-2\tabcolsep-1.3333\arrayrulewidth}|   
        } \hline
        
            \textbf{Communication} & The channel condition dynamically varying based on network topology and the communication type (unicast or broadcast). If multiple nodes want to communicate in the same time it could be happen \textbf{congestion} or \textbf{starvation} on the medium channel \\ \hline

            \textbf{Networking} & The flow information that was send from a node $A$ to a node $B$ can be unicat or multicast (following access algorithm of \textbf{CSMA/CA}). In the same network it can be present multiple different nodes: \textbf{heterogeneity}\\ \hline

            \textbf{Mobility} & Not only for the high speed but for the dynamically change of the topology. It can be predict.\\ \hline

        \end{tabular}
    \end{minipage}
\end{figure}

\section{Wireless Communication}
\begin{enumerate}[nosep]
    \item \textbf{Broadcast Media} (one way): frequency are used for business purposes, you can only receiveing data, like police radio.
    \begin{boxA}
        \centering
        \textbf{\textit{Traffic Message Channel}} (\textbf{\textit{TMC}}) \\
        \textbf{\textit{Radio Distrinbution System}} (\textbf{\textit{RDS}})
    \end{boxA}
    \item \textbf{Cellular Lane}: it is possible to put bottom in \textbf{V2X}. Divide the world into cell (\textbf{\textit{User Equipment - UE}}), each served by base station (\textbf{3GPP} have \textit{license} spectrum frequency).
    \begin{boxA}
        \centering
        \textbf{\textit{Frequency Divide Multiple Access}} (\textbf{\textit{FDMA}}) \\
        \textbf{\textit{Radio Network Core}} (\textbf{\textit{RNC}})
    \end{boxA}
    \item \textbf{IEEE 802.11p}: new communication protocol based on the requirements of the \textbf{V2X}.
\end{enumerate}

\section{C-V2X}
It is the acronym for \textbf{Cellular V2X} and try to embrace the characteristic of \textbf{V2X} on the public system, this type of implementation leads to some problem, like: 
\begin{enumerate}[nosep]
    \item using an infrastructure alredy used for other purpose it is possible to have \textit{delay}.
    \item if the number of the nodes in the infrastructure double (the ones alredy present and all the vehicles plus the RSUs) there are a lot of nodes in the infrastructure. This can lead to \textit{capacity} problems
    \item if we consider that one autonomous car use $4000Gb$ of data per day, it can involve some \textit{bit-rate} problem.
    \item it is \textit{expensive}.
\end{enumerate}
Since the cellular line infrastructure it was create for other purpose, instead the \textbf{V2X}, the downlink and uplink are \textbf{unbalance}, so the communication channel could be:
\begin{enumerate}[nosep]
    \item \textbf{downlink}: from the server to the device the delay is on the order of $10ms$. \textbf{\textit{Forward Access Channel}} (\textbf{\textit{FACH}}).
    \item \textbf{uplink}: from the device to the server, it can have a delay approximately of $50ms$ (if we use \textbf{LTE} it can be lowered until $25ms$). \textbf{\textit{Random Access Channel}} (\textbf{\textit{RACH}}).
    \item there is also a dedicated channel with a delay approximately between $250ms$ and $2s$. \textbf{\textit{Dedicated Transport Channel}} (\textbf{\textit{DCH}}).
\end{enumerate}
It is possible to classified the \textbf{C-V2X} based on the \textbf{radio interfaces} used: \textbf{LTE-Uu} each node is attach to the infrastructure and for communicate each other a node $A$ upload the information on the server and the node $B$ read throught the server (\textit{license spectrum}) or the \textbf{LTE-PC5}, where there is not infrastructure. \\
In the \textbf{LTE-PC5} if you are in the same area of coverage of an antenna you can use the support of the infrastructure (never implemented), instead if you are out of coverage it is possible to use point-to-point commnuication using \textbf{LTE} at $5.9Ghz$ frequency ($\simeq$ 802.11p). \\
The \textbf{physical layer} of \textbf{C-V2X} is divide into \textbf{\textit{Resource Block}} (\textbf{\textit{RB}}) with a width of $180MHz$ each one. Every \textbf{RB} is split into \textbf{\textit{Time Unit}} (\textbf{\textit{TU}}) each one of $1ms$ long. In this way is performed a matrix where on the y-axis there are the \textbf{frequency} and on the x-axis the \textbf{time}. If a node wants to transmit something it needs to take possession of a \textbf{RB} for a certain amount of time ($m$ \textbf{TU}), for each transmission there are two different type of message classes:
\begin{itemize}[nosep]
    \item \textbf{\textit{Transport Block}} (\textbf{\textit{TB}}) where is allocated the data.
    \item \textbf{\textit{Sidelink Control Information}} (\textbf{\textit{SCI}}) that permit to manage the communication: rent a \textbf{RB} for a certain amount of time. In this type of message is included the \textbf{\textit{Modulation and Coding Scheme}} (\textbf{\textit{MCS}}).
\end{itemize}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{img/cv2x}
\end{figure}
\textbf{TB} and \textbf{SCI} are transmitted in adjacent \textbf{RBs}, the \textbf{SCI} requires two adjacent \textbf{RB}. The idea behind the medium access is similar to bluetooth, where we change the frequency each time we want to transmit a piece of information, in this case we take a frequency for a certain amount of time for the entire duration of the transmission $\cong$ \textbf{\textit{Time Division Multiple Access}} (\textbf{\textit{TDMA}}) it is mandatory to have synchronize all nodes $\rightarrow$ need \textbf{GPS} and \textbf{GNSS} for the synchronization.

\newpage
\section{802.11p}

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=0.45\textwidth]{img/11a}
        \caption{802.11 data flow}
        \label{fig:11a}
        
        \begin{flushleft}
            \textbf{IEEE 802.11} \\
            WiFi: high latency and used by everyone $\rightarrow$ lot of pollution in the world spectrum. It is created for the internet navigation have completly different requirements by \textbf{V2X}. There is no \textbf{QoS} by default. \\
            \textbf{\textit{Basic Service Set}} (\textbf{\textit{BSS}}): there is a node that orchestrate the network (authentication, routing and iP assignement) contain the \textbf{BSSID}. The Fig. \ref{fig:11a} define how a client joining the communication. The server sent a \textbf{beacon} that contain the frequency for that access point and propagate the \textbf{SSID}.
        \end{flushleft}
    \end{minipage}
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \includegraphics[width=0.45\textwidth]{img/11p}
        \caption{802.11p data flow}
        \label{fig:11p}

        \begin{flushleft}
            \textbf{IEEE 802.11p} \\
            \begin{boxA}
                \centering
                \textbf{bandwidth}: $10MHz$ \\
                \textbf{throughput}: $3-27Mbit/s$ \\
                \textbf{range}: up to $1km$ \\
                \textbf{speed}: $200km/h$
            \end{boxA}
            It is created knowing the requirements for the \textbf{V2X} use the \textit{MAC Layer} of \textbf{802.11a} plus extension:
            \begin{enumerate}[nosep]
                \item random \textbf{MAC address}
                \item use of \textbf{\textit{Enhanced Distributed Channel Access}} (\textbf{\textit{EDCA}}) for prioritizing the message on the medium access (\textbf{QoS})
                \item multi-frequency and multi-radio capabilities
            \end{enumerate}
        \end{flushleft}
    \end{minipage}
\end{figure}
The base idea is of \textbf{802.11p}: there is no need of an iP you can listen and talk on a particular frequency. (Fig. \ref{fig:11p}), is named: \textbf{\textit{Outside The Context of a BSS}} (\textbf{\textit{OCB}}). \textbf{802.11p} is the technologies adopt for the implementation of \textbf{V2X} also known as \textbf{\textit{Wireless Access in Vehicular Environment}} (\textbf{\textit{WAVE}}). Two new tipe of node: \textbf{\textit{RoadSide Unit}} (\textbf{\textit{RSU}}) and \textbf{\textit{On-Board Unit}} (\textbf{\textit{OBU}}).

\subsection{Physical Access}
There are two mainly actor in the \textbf{802.11p} network: the \textit{provider} and the \textit{user}, but there is no technical difference between them. The main task of the \textbf{provider} is to send a \textbf{\textit{On-Deamand Beacon}} ($\simeq$ beacon in \textbf{802.11}) that contain the information and parameter to join the network. The \textbf{physical access} is \textbf{wireless}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.55\textwidth]{img/802_11_dcf}
\end{figure}
\begin{boxA}
    \textbf{\textit{Distributed Coordinator Function}} (\textbf{\textit{DCF}}) of \textbf{802.11} two main intervals (it is a time that a station have to wait before transmit):
    \begin{enumerate}[nosep]
        \item \textbf{\textit{SIFS}} - \textbf{\textit{Short Interframe Space}}: before the acknoledgement.
        \item \textbf{\textit{DIFS}} - \textbf{\textit{Data Interframe Space}}: before the data.
    \end{enumerate}
    In a wireless environment it is not possible to anticipate what the other are going to do: \textbf{Carrier Sense} getting a look at the medium listen until is idle, \textbf{Avoid Collision} if the medium is congestionated you can increase the intervals.
\end{boxA}

\subsection{Quality of Service}
Before continue the physical access part on the \textbf{802.11p} small introduction on what is the \textbf{QoS}. Differently from module 1, in this part of course we have \textbf{logical link}, but \textbf{channel/medium wireless}, in this way the priority it cannot be written in the protocol, but must be written in the message and we have to treat according to its rules (written in the msg). \\
$\rightarrow$ give me a packet I will control and I will decided what to do according to the service that you want. \\ \newline
\textbf{QoS} is the overall performance of a telephony or computer network (important for traffic with special requirements $\rightarrow$ different protocols means different requirements). We need to have a \textbf{dedicated QoS} for each \textbf{TCP/iP level}. 
\begin{enumerate}[nosep]
    
    \item \textbf{\textit{H2N}} (include \textit{physical layer} and \textit{data link layer}) 3-bit field called \textbf{\textit{Priority Code Point}} (\textbf{\textit{PCP}}) identify the priority of that frame using these 3-bit:
    \begin{itemize}[nosep]
        \item the type of modulation that we have on the medium $\rightarrow$ \textbf{bitrate}.
        \item bandwidth
    \end{itemize}
    \begin{figure}[h]
        \centering
        \begin{tabular}{ | p{1cm} | p{3cm} | p{7cm} | } \hline
            \textbf{PCP} & \textbf{priority} & \textbf{traffic type} \\ \hline
        \end{tabular} \\
        \begin{tabular}{ | p{1cm} | p{3cm} | p{7cm} | } \hline
            1 & 0 (lowest) & background \\ \hline
            0 & 1 & best effort \\ \hline
            2 & 2 & excellent effort \\ \hline
            3 & 3 & critical application \\ \hline
            4 & 4 & video $<100ms$ latency and jitter \\ \hline
            5 & 5 & voice $<100ms$ latency and jitter \\ \hline
            6 & 6 & internal control \\ \hline
            7 & 7 (highest) & network control \\ \hline
        \end{tabular}
    \end{figure}

    \item \textbf{\textit{Network (iP)}} is used for \textbf{packet schedule} and \textbf{routing protocol}:
    \begin{itemize}[nosep]
        \item \textbf{\textit{IntServ}}: rent a certain resourse for all the router on the path between you and the end node (impossible to actuate except for \textit{bank domain}).
        \item \textbf{\textit{DiffServ}}: every single hop you try to do your best. If there is a packets more important than one other the router try to forward first the most important one. The \textbf{problem} is that this type of control affected the end-to-end performance with all the router performance (the scheduling complexity is not linear).
        \begin{boxA}
            \textbf{\textit{Different Services Code Point}} (\textbf{\textit{DSCP}}) is the method used in networking to classify and manage network traffic by assigning 6.bit value in the iP header, allowing for prioritization of different type of data. $2^6 = 64$ different class. The mainly used are the \textbf{\textit{Per-Hop Behaviour}} (\textbf{\textit{PHB}}):
            \begin{itemize}[nosep]
                \item (default) \textbf{best-effort}
                \item \textbf{\textit{Expedited Forwarding}} (\textbf{\textit{EF}}): low loss and latency traffic.
                \item \textbf{\textit{Assured Forwarding}} (\textbf{\textit{AF}}): assurance of delivery.
                \item \textbf{class selector PHBs}: backword compatibility
            \end{itemize}
        \end{boxA}
        We cannot have a one-to-one conversion from 3-bit of \textbf{H2N} to the 6-bit of \textbf{iP} so it was define a mapping between \textbf{PCP} and \textbf{DSCP}.
        \begin{figure}[h]
            \centering
            \begin{tabular}{ | p{1cm} | p{2cm} | p{2cm} | c | } \hline
                Lv2 & \multicolumn{2}{ | c | }{Lv3} & \multirow{2}{*}{\centering \textbf{Application}} \\ \cline{1-3}
                \textbf{PCP} & \textbf{DSCP} & \textbf{PHB} & \\ \hline
                0 & 0 & 0 & best effort \\ \hline
                1 & 8 & CS1 & torrent \\ \hline
                1 & 10 & AF11 & bulk data \\ \hline
                2 & 16 & CS2 & network management \\ \hline
                2 & 18 & AF21 & transactional data \\ \hline
                3 & 24 & CS3 & call signaling \\ \hline
                3 & 26 & AF31 & mission-critical data \\ \hline
                4 & 32 & CS4 & streaming video \\ \hline
                4 & 34 & AF41 & video conferancing \\ \hline
                5 & 46 & EF & voice \\ \hline
                6 & 48 & CS6 & routing \\ \hline
                7 & 56 & CS7 & network control \\ \hline
            \end{tabular}
        \end{figure}
    \end{itemize}

    \item \textbf{\textit{Transport}}:
    \begin{itemize}[nosep]
        \item \textbf{TCP}: congestion control, fairness among flows and friendliness among TCP algorithm.
        \item \textbf{UDP}: no congestion control, problem delegated at layer three.
    \end{itemize}

    \item \textbf{\textit{Application}}: it became \textbf{Quality of Experience}

\end{enumerate}

\subsection{Physical Access pt.2}
\textbf{802.11} uses \textbf{DCF} for the medium access but for the \textbf{V2X} purpose there are some limitation:
\begin{itemize}[nosep]
    \item there is no congestion control: many station means many collision that produce lower bandwith and have not enough bandwidth means congestive collapse.
    \item no QoS guarantees: there is no difference between packet with higher priority instead of the lower priority.
\end{itemize}
In some cases \textbf{DCF} is replaced by \textbf{\textit{Point Coordination Function}} (\textbf{\textit{PCF}}) but need an infrastructure, that in \textbf{V2X} can be present or not and uses a \textit{centralized function} (present in the \textbf{AP}) for enabling the QoS mechanism. \\ \newline
\textbf{802.11p} uses a \textbf{\textit{Hybrid Coordination Function}} (\textbf{\textit{HCF}}) like policy for the medium access. 
\begin{boxA}
    \textbf{HCF} details:
    \begin{itemize}[nosep]
        \item include the \textbf{802.11e} amendment for the definition of a set of QoS enhancements for wireless LAN application through modification to the media access control layer.
        \item convert the \textbf{DCF} into \textbf{\textit{Enhanced Distributed Channel Access}} (\textbf{\textit{EDCA}}).
        \item convert the \textbf{DIFS} into the \textbf{\textit{Arbitration Interframe Space}} (\textbf{\textit{AIFS}}): it is close to what we have seen in CANBus, permit to associated a number which change according to the priority of the packet that you have to transmit.
        \item defines \textbf{\textit{Traffic Categories}} (\textbf{\textit{TC}}).
    \end{itemize}
\end{boxA}
The core idea is force an application to use an \textbf{AIFS} shorter or larger according to is priority: modify the \textbf{CSMA/CA} using shorter \textbf{AIFS} for higher priority packets.
\begin{boxA}
    \textbf{\textit{Enhanced Distributed Channel Accass}} (\textbf{\textit{EDCA}}) \\
    It is a \textbf{\textit{TCMA}} protocol (\textbf{\textit{Tiered Contention Multiple Access}}) that define the \textbf{AIFS}. It classify user data in four \textbf{Access Categories} (\textbf{AC}): from \textbf{AC0} (lowest priority) to the \textbf{AC3} (highest priority). \\
    It permit to enable \textbf{Burst Mode} using the \textbf{\textbf{Transmission Opportunity}} (\textbf{\textit{TXOP}}): is a bounded time interval during which a station can send many frames as possible, during this period the station does not need to use standard \textbf{EDCA} to access the channel. \\
    Each \textbf{ACs} has different \textbf{\textit{Contention Window}} (\textbf{\textit{CW}}), \textbf{AIFS} and \textbf{TXOP}.
\end{boxA}
In \textbf{802.11p} te four access categories have its own queue and each of then compete in an indipendent way (Fig.~\ref{fig:edca}) to access to the medium (with its own algorithm), instead of \textbf{802.11} we have the \textit{scheduler}, but in the \textbf{11p} is not enough because a device $A$ have to transmit a new packet with higher priority than a packet that the device $b$ have to transmit it can collide with the last one. In this protocol the \textbf{access} is more important tha the \textbf{backbone}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.45\textwidth]{img/edca}
    \caption{Medium Access - EDCA}
    \label{fig:edca}
\end{figure}
\textbf{HCF} maps eight user priorities with four access categories $\rightarrow$ mapping:

\begin{figure}[h]
    \centering
    \begin{tabular}{ | c | c | c | c | c | c | } \hline
        & \multicolumn{3}{ | c | }{\textbf{802.11p}} & \multicolumn{2}{ | c | }{\textbf{802.11p QoS}} \\ \hline
        priority & \textbf{PCP} & \textbf{Acronym} & \textbf{Traffic Type} & \textbf{AC} &  \textbf{Disignation} \\ \hline
        lowest & 1 & BK & background & AC\_BK & background \\ \hline
        & 2 & - & spare & AC\_BK & background \\ \hline
        & 0 & BE & best effort & AC\_BE & best effort \\ \hline
        & 3 & EE & excellent effort & AC\_BE & best effort \\ \hline
        & 4 & CL & controlled load & AC\_VI & video \\ \hline
        & 5 & VI & video & AC\_VI & video \\ \hline
        & 6 & VO & voice & AC\_VO & voice \\ \hline
        highest & 7 & NC & network control & AC\_VO & voice \\ \hline
    \end{tabular}
\end{figure}

\newpage
Another important table is the definition of the \textbf{EDCA} parameter for the \textbf{802.11p} communication for every type of \textbf{AC}

\begin{figure}[h]
    \centering
    \begin{tabular}{ | c | c | c | c | c | } \hline
        \textbf{AC} & \textbf{CW}$_{min}$ & \textbf{CW}$_{max}$ & \textbf{AIFS} & \textbf{Max TXOP} \\ \hline
        AC\_BK & 15 & 1023 & 9 & 0 \\ \hline
        AC\_BE & 15 & 1023 & 6 & 0 \\ \hline
        AC\_VI & 7 & 15 & 3 & 3.008ms \\ \hline
        AC\_VO & 3 & 7 & 2 & 1.504ms \\ \hline
        legacy DCF & 15 & 1023 & 2 & 0 \\ \hline
    \end{tabular}
\end{figure}

\subsection{802.11p Upper Layer}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\textwidth]{img/etsi_11p}
    \caption{European Standard for 802.11p}
    \label{fig:etsi_11p}
\end{figure}
\textbf{\textit{Decentralize Congestion Control}} (\textbf{\textit{DCC}}): the environment change based on where we are and so accordin with the environment and the application there are multiple parameter to continuosly read for avoid congestion. It is used an \textbf{\textit{Finite State Machine}} (\textbf{\textit{FSS}}) to know how to set the \textbf{802.11p} parameter for the transmission.
There are three different state:
\begin{enumerate}[nosep]
    \item \textbf{relaxed}: low data rate and high range
    \item \textbf{active}: neutral
    \item \textbf{restrictive}: high data rate and low range
\end{enumerate}
To relax the state (from restrictive to relaxed) the same \textit{maxChannelLoad} must be in the correct range at least for five seconds, instead to limit the state (from relaxed to restrictive) the same \textit{minChannelLoad} must be in the correct range at least for one second, this difference between the transiction direction is to avoid the \textbf{isteresis} that means jumping from a state to another continuosly, polluting the transmission.

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{Input}: will allow us to understand uf we have to change the state, normally is based on the \textbf{channel load} or the \textbf{measured received power} (\textbf{RSS}).
    \end{minipage}
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{Output}: each output have an associated value for each state:
        \begin{itemize}[nosep]
            \item \textbf{Transmission Power}: is the bulk movement of electrical energy from a generating site
            \item \textbf{Minimum Packet Interval}: how fast modulate
            \item \textbf{BitRate}: how dealing the contention
        \end{itemize}
    \end{minipage}
\end{figure}

\subsection{ETSI Message}

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{\textit{Cooperative Awareness Message}} (\textbf{\textit{CAM}}) \\
        Very based information according to the awareness which is used to increase safety (position, speed and heading $\rightarrow$ where the vehicle is pointing geographically speaking). Is a periodic message, where the period is between $[100ms, 1s]$ if something happen in that interval there is no way of notification. The \textbf{CAM} check if $\Delta angle > 4^{\circ}$ or $\Delta position > 5m$ or $\Delta speed > 1m/s$ if nothing of this param change significantly the \textbf{CAM} msg is sent every second. 
    \end{minipage}
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{\textit{Decentralize Environmental Notification Message}} (\textbf{\textit{DENM}}) \\
        decentralize because is something transmitted by who want, environment notification because is caused by event (\textbf{event-driven}) caused by vehicular sensor. Event like: hand braking, accident, construction work, imminente collision, low visibility, high wind, icy roads, etc. \\
        Have local scope based on area, road topology and driving direction        
    \end{minipage}
\end{figure}
\textbf{CAM} message is \textbf{strongly related} with \textbf{GPS}.

\section{Broadcast \& Flooding}
\textbf{Flooding} (Multi-Hop Broadcast), simple protocol: if we receive a new message $\rightarrow$ send (retransmit, propagate), instead if we receive a duplicate message $\rightarrow$ do not do anything (idle).
\begin{boxA}
    \textcolor{red}{\textbf{Broadcast Storm}} is the problem that we want to avoid, because can carry to some consequences like:
    \begin{itemize}[nosep]
        \item \textbf{interference}: impact on other system
        \item \textbf{collision}: impact on other user
        \item \textbf{contention}: impact on other application
    \end{itemize}
\end{boxA}
In \textbf{VANET} was found a specific solution to this type of problem: \textbf{Broadcast Suppression} where there is no needs of neighbor information, control message and permit to maximizes distance per hops and minimize packet loss.
\begin{boxA}
    \textit{
        Upon receiving a packet from node $i$, node $j$ checks the packet ID and rebroadcasts with probability $p_{ij}$ if it receives the packet for the first time; otherwise , it discard the packet.
    }
\end{boxA}
The probability can be compute on the \textbf{distance} from the sender to the receiver based on the transmission \textit{radius} (\textbf{GPS}) or based on the \textbf{RSS} knowledge. 

\begin{figure}[h]
    \centering
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{Broadcast Suppression: GPS based} \\
        \begin{center}
            \begin{math}
                p_{ij} = 
                \begin{cases}
                    0, \qquad D_{ij} < 0 \\
                    \frac{D_{ij}}{R}, \quad 0 \leq D_{ij} < R \\
                    1, \qquad \text{otherwise}
                \end{cases}
            \end{math}
        \end{center}
        Where $D_{ij}$ is the \textbf{GPS} geographical distance between nodes $i$ and $j$.
    \end{minipage}
    \begin{minipage}[t]{0.45\textwidth}
        \centering
        \textbf{Broadcast Suppression: RSS based} \\
        \begin{center}
            \begin{math}
                p_{ij} = 
                \begin{cases}
                    0, \qquad \quad x_{ij} > x_{max} \\
                    \frac{x_{max} - x_{ij}}{x_{max} - x_{min}}, x_{min} \leq x_{ij} < x_{max} \\
                    1, \qquad \quad \text{otherwise}
                \end{cases}
            \end{math}
        \end{center}
        Where $x = RSS$, $RSS_{ij}$ is the receiver signal strength of the last broadcast packet received at node $j$. In case 0 and 1 update the min and max.
    \end{minipage}
\end{figure}
The core idea is: in the close/dense scenario, the probability of retransmission is lower to avoid congestion/noise, otherwise in far/sparse scenarios, the probability of retransmission is higher to permit propagation. \\
To the other side, the \textbf{problem}, of this algorithm is: the fragmentation of the network (due to an accident) or the undirected message dissemination (you cannot chose the direction of the flooding).

\section{802.11bd - NGV}
\textbf{\textit{New Generation V2X}} (\textbf{\textit{NGV}}). \\
\textbf{Motivation}:
\begin{figure}[h]
    \begin{minipage}[t]{0.4\textwidth}
        \begin{itemize}[nosep]
            \item higher throughput
            \item increase range
            \item lower complexity receiver
            \item ranging
        \end{itemize}
    \end{minipage}
    \begin{minipage}[t]{0.5\textwidth}
        \begin{itemize}[nosep]
            \item mm-Wave support: new $60GHz$ spectrum for smart application sensing and radar
            \item improvements benefitting 802.11p receiver
        \end{itemize}
    \end{minipage}
\end{figure}
The core idea of this transiction to a new \textbf{V2X} standard is to have the \textbf{Backwards Compatibility}, how it is perform? 
\begin{enumerate}[nosep]
    \item not changing at all the way we are accessing to the medium.
    \item the initial part of \textbf{TX} message it must be equal (like CAN-FD).
    \item a flag in the \textbf{TX} message to know if the station is \textbf{NGV} compliant.
\end{enumerate}

\textbf{802.11bd Message}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | c | c | c | c | } \hline
        \multicolumn{3}{ | c | }{\textbf{802.11p preamble}} & \multicolumn{3}{ | c | }{\textbf{802.11bd NGV preamble}} & \multicolumn{3}{ | c | }{\textbf{802.11bd NGV data}} \\ \hline
        STF & LTF & SIG & RL-SIG & NGV-SIG & RNGV-SIG & STF & LTF & DATA \\ \hline
    \end{tabular}
\end{center}

The communication was create to being able to operate in both way: \textbf{802.11p} and \textbf{802.11bd}: the preamble is alway $10MHz$, instead when start the \textbf{802.11bd preamble} it can reach the $20MHz$, the fairness does not change: the QoS is mantain like the \textbf{11p} (\textbf{CSMA/CA}). The radio spectrum is used efficiently (using \textbf{DCC}).
\begin{itemize}[nosep]
    \item \textbf{\textit{Short Training Field}} (\textbf{\textit{STF}}): used for coarse synchronization.
    \item \textbf{\textit{Long Training Field}} (\textbf{\textit{LTF}}): used for fine-sync and initial channel estimation.
    \item \textbf{\textit{Signal Field}} (\textbf{\textit{SIG}}) is coded by the receiver to determine \textbf{TX} parameters, like: 24 rate bits, lenght and parity information.
\end{itemize}
In the \textbf{802.11p preamble} there are information that permit to a vehicle that speak only \textbf{802.11p} to understand when the \textbf{NGV transmission} ends, in this way the vehicles in \textbf{802.11p} can try to have access to the channel knowing what happen on it (otherwise of this type of vehicle the entire communication it could be like a noise). Using the technologies over the \textbf{802.11bd} is possible to increase the throughput by $8\%$. There are three possible communication way:
\begin{itemize}[nosep]
    \item \textbf{802.11p} to \textbf{802.11p}.
    \item \textbf{802.11p} to \textbf{802.11bd} and viceversa.
    \item \textbf{802.11bd} to \textbf{802.11bd} (it could be unicast or broadcast).
\end{itemize}

\textbf{\textit{802.11bd Technical Features}}:
\begin{enumerate}[nosep]

    \item \textbf{Modulation}:
    \begin{itemize}[nosep]
        \item \textbf{robustness}: \textbf{BPSK-DCM 1/2} is intended for use cases and applications requiring very low sensitivity.
        \item \textbf{throughput}: \textbf{256-QAM} allow up to $39Mbit/s$ in a single $10MHz$ ($44\%$ more than \textbf{11p}).
    \end{itemize}

    \item \textbf{Signal Structure}:
    \begin{itemize}[nosep]
        \item \textbf{spacing}: same subcarrier spacing as \textbf{11p} ($156.25kHz$)
        \item \textbf{subcarriers}: \textbf{11bd} uses a larger fraction of the channel.
    \end{itemize}

    \item \textbf{Channel Coding}: \textbf{\textit{Low Density Parity Check}} (\textbf{\textit{LDPC}}) forward \textbf{\textit{Error Correction Coding}} (\textbf{\textit{FEC}}) allow to use the same sensitivity to be able to use much more efficiently modulation scheme

    \item \textbf{\textit{Channel Estimation and Tracking}}: every four block uou have a new estimation (\textbf{11bd}) $\rightarrow$ understand the channel conditions.

    \item \textbf{\textit{MIMO}}: offering a potential gain in unicast transmission of 2 times higher throughput. This operational mode is not intended for the broadcast operation.

    \item create two subchannel of $5.9GHz$ one for the \textbf{\textit{Control Channel}} (\textbf{\textit{CCH}}) used for safety message and network control and the second one, is the \textbf{\textit{Service Channel}} (\textbf{\textit{SCH}}) used for all other message.

    \item \textbf{Fully backward compatible}: \textbf{11bd} operation utilizes two adjacent $10MHz$ channels to achive higher throughput. These two adjacent channel can simultaneously be utilized as a $20MHz$ channel or as independt $10MHz$ channels.

    \item \textbf{Ranging for positioning support}: in \textbf{11bd} there is an alternative to \textbf{GNSS} (like in \textbf{GPS-denied} environment) which is a subset of the \textbf{\textit{Fine Timining Measurement}} (\textbf{\textit{FTM}}) $\rightarrow$ derived from \textbf{802.11az Enhanced Positioning}:
    \begin{center}
        $d^i = c \cdot t^i = c \cdot \frac{(t^i_4 -t^i_1) - (t^i_3 - t^i_2)}{2}$ \\
        where $d^i$ is the distance computed in the i-th FTM iteration.
    \end{center}

    \item \textbf{\textit{Multichannel Operation}} (\textbf{\textit{MCO}})

\end{enumerate}